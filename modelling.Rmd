---
output: pdf_document
---

```{r}
library(tidyverse)
library(randomForest)
library(caret)
set.seed(420)
library(kableExtra)

```

*Partición muestras de entrenamiento, validación y test*

Una vez calculada la variable respuesta y las variablex explicativas/predictoras se procede a construir los modelos predictivos. En primer lugar se particionan los conjuntos de datos en las muestras de entrenamiento, validación y test. En la muestra de entrenamiento se encuentran los datos con los que se entrarán los modelos, es decir, son los datos a partir de los cuales los modelos van observar el fenómeno de estudio y van a aprender sobre él. La muestra de validación se utiliza para obtener una optimización de los hyper parámetros. En inglés este proceso se llama *hyper-parameter fine tunning*. Finalmente, la muestra test la forman los datos sobre los cuales se va a evaluar el rendimiento de los modelos entrenados con los datos *train + validation* después de tunear los hyper parámetros. 

\setlength\parskip{5ex}
Las series temporales de precios necesitan un tratamiento especial al momento de hacer las particiones entre muestras de entrenamiento, validación y test ya que se debe mantener la estructura temporal inherente en los datos. 

* Muestra de entrenamiento: 2000-2015
* Muestra de validación: 2016
* Muestra de test: 2017-2018

\setlength\parskip{5ex}
Los modelos que se construyen requieren una muestra de entrenamiento considerable al tener que captar largas tendencias en los precios. Además los hyper parámetros que se deben optimizar, en el caso del Random Forest, no son demasiados y por eso se decide utilizar 17 años de entrenamiento y sólo 6 meses para la muestra de validación y test.

```{r}
load("C:/Users/i0386388/Desktop/tesis/data_model_ready.RData",.GlobalEnv)
```

```{r}
source("C:/Users/i0386388/Desktop/tesis/Tesis/partitioning2.R")
```

PONER AQUÍ EL NÚMERO TOTAL DE EXPERIMENTOS: CUANTOS MODELOS SE HACEN DE CADA TIPO, CONTANDO PARAMETER FINE TUNING Y TEST PERFORMANCE

*Modelización y resultados*

*Random Forest*

\setlength\parskip{5ex}
Para realizar los experimentos utilizando este modelo descrito en el apartado 6.1 del presente trabajo se optimiza el parámetro `mtry` [véase @tuningRF]. Acorde con la documentación de la función `randomForest` que se puede consultar en [@RF], el parámetro `mtry` controla el número de variables aleatóriamente muestreadas que son candidatas en cada *split* del árbol. Es decir, es el número de variables a tener en cuenta en cada *split* a partir de las cuales se selecciona la que mejor particiona los datos. Esta optimización se hace sobre la muestra de validación utilizando como métrica el % de casos mal clasificados. Esto significa que se selecciona el valor de `mtry` que propocione un menor porcentage de casos mal clasificados (1-accuracy).  


\setlength\parskip{5ex}
Seguidamente se muestra una tabla resumen con el valor óptimo del hyper parámtero `mtry` para cada tipo de alisado de cada empresa. Además se incluye en la tabla el valor de *accuracy* obtenido con cada modelo sobre la muestra de validación utilizando el parámetro óptimo `mtry` para cada tipo de alisado.

```{r}
load("C:/Users/i0386388/Desktop/tesis/mtry_errors_datasplit.RData")

```

```{r}
#KO

a<-data.frame(mtry1m=as.numeric(c(which(errors_KO_30_1m_target_feature==min(errors_KO_30_1m_target_feature))[1],
                                    which(errors_KO_60_1m_target_feature==min(errors_KO_60_1m_target_feature[-1]))[1],
                                   which(errors_KO_90_1m_target_feature==min(errors_KO_90_1m_target_feature[-1]))[1],
                                   which(errors_KO_fun_1m_target_feature==min(errors_KO_fun_1m_target_feature[-1]))[1])),
              accuracy1m=as.numeric(c((1-min(errors_KO_30_1m_target_feature))*100,
                                    (1-min(errors_KO_60_1m_target_feature[-1]))*100,
                                    (1-min(errors_KO_90_1m_target_feature[-1]))*100,
                                    (1-min(errors_KO_fun_1m_target_feature[-1]))*100)),
              
              
              mtry2m=as.numeric(c(which(errors_KO_30_2m_target_feature==min(errors_KO_30_2m_target_feature[-1]))[1],
                                    which(errors_KO_60_2m_target_feature==min(errors_KO_60_2m_target_feature[-1]))[1],
                                   which(errors_KO_90_2m_target_feature==min(errors_KO_90_2m_target_feature))[1],
                                   which(errors_KO_fun_2m_target_feature==min(errors_KO_fun_2m_target_feature))[1])),
              
                 accuracy2m=as.numeric(c((1-min(errors_KO_30_2m_target_feature[-1]))*100,
                                    (1-min(errors_KO_60_2m_target_feature[-1]))*100,
                                    (1-min(errors_KO_90_2m_target_feature))*100,
                                    (1-min(errors_KO_fun_2m_target_feature))*100)),
              
              
              mtry3m=as.numeric(c(which(errors_KO_30_3m_target_feature==min(errors_KO_30_3m_target_feature[-1]))[1],
                                    which(errors_KO_60_3m_target_feature==min(errors_KO_60_3m_target_feature[-1]))[1],
                                   which(errors_KO_90_3m_target_feature==min(errors_KO_90_3m_target_feature[-1]))[1],
                                   which(errors_KO_fun_3m_target_feature==min(errors_KO_fun_3m_target_feature))[1])),
              
              accuracy3m=as.numeric(c((1-min(errors_KO_30_3m_target_feature[-1]))*100,
                                    (1-min(errors_KO_60_3m_target_feature[-1]))*100,
                                    (1-min(errors_KO_90_3m_target_feature[-1]))*100,
                                    (1-min(errors_KO_fun_3m_target_feature))*100))
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

kable(a, "latex") %>%
  add_header_above(c(" ", "Predicción 1 mes" = 2, "Predicción 2 meses" = 2,"Predicción 3 meses"=2)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))

```
  \captionof{table}{Coca Cola CO.: valores optimizados para mtry y accuracy obtenida}

\setlength\parskip{5ex}

Como se puede observar para la empresa Coca-Cola CO. el mejor resultado, es decir la *accuracy* obtenida más alta, para la predicción a 1 mes se obtiene con el alisado correspondiente a una media móbil exponencial a 30 días con un valor de 63.5%. Para la predicción a 2 meses el mejor resultado es de 75% de accuracy y se obtiene alisando los datos con una EMA de 90 días  (el mejor resultado global para la muestra de validación). Por lo que respecta a la predicción a 3 meses el mejor resultado se obtiene alisando los datos con una EMA 90 días con un valor de 67.46%. Para esta empresa no se aprecia un patrón de crecimiento de la *accuracy* sino más bien unos resultados repartidos más o menos uniformente entre los distintos experimentos realizados.

```{r}
#APPLE


a<-data.frame(mtry1m=c(as.numeric(which(errors_AAPL_30_1m_target_feature==min(errors_AAPL_30_1m_target_feature))[1]),
                                    as.numeric(which(errors_AAPL_60_1m_target_feature==min(errors_AAPL_60_1m_target_feature))[1]),
                                   as.numeric(which(errors_AAPL_90_1m_target_feature==min(errors_AAPL_90_1m_target_feature))[1]),
                                   as.numeric(which(errors_AAPL_fun_1m_target_feature==min(errors_AAPL_fun_1m_target_feature))[1])),
              accuracy1m=as.numeric(c((1-min(errors_AAPL_30_1m_target_feature))*100,
                                    (1-min(errors_AAPL_60_1m_target_feature[-c(35:37)]))*100,
                                    (1-min(errors_AAPL_90_1m_target_feature))*100,
                                    (1-min(errors_AAPL_fun_1m_target_feature))*100)),
              
              
              mtry2m=as.numeric(c(which(errors_AAPL_30_2m_target_feature==min(errors_AAPL_30_2m_target_feature))[1],
                                    which(errors_AAPL_60_2m_target_feature==min(errors_AAPL_60_2m_target_feature[-1]))[1],
                                   which(errors_AAPL_90_2m_target_feature==min(errors_AAPL_90_2m_target_feature))[2],
                                   which(errors_AAPL_fun_2m_target_feature==min(errors_AAPL_fun_2m_target_feature))[1])),
              
                 accuracy2m=as.numeric(c((1-min(errors_AAPL_30_2m_target_feature))*100,
                                    (1-min(errors_AAPL_60_2m_target_feature[-1]))*100,
                                    (1-min(errors_AAPL_90_2m_target_feature))*100,
                                    (1-min(errors_AAPL_fun_2m_target_feature))*100)),
              
              
              mtry3m=as.numeric(c(which(errors_AAPL_30_3m_target_feature==min(errors_AAPL_30_3m_target_feature))[1],
                                    which(errors_AAPL_60_3m_target_feature==min(errors_AAPL_60_3m_target_feature))[1],
                                   which(errors_AAPL_90_3m_target_feature==min(errors_AAPL_90_3m_target_feature))[1],
                                   which(errors_AAPL_fun_3m_target_feature==min(errors_AAPL_fun_3m_target_feature))[1])),
              
              accuracy3m=as.numeric(c((1-min(errors_AAPL_30_3m_target_feature))*100,
                                    (1-min(errors_AAPL_60_3m_target_feature))*100,
                                    (1-min(errors_AAPL_90_3m_target_feature))*100,
                                    (1-min(errors_AAPL_fun_3m_target_feature))*100))
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

kable(a, "latex") %>%
  add_header_above(c(" ", "Predicción 1 mes" = 2, "Predicción 2 meses" = 2,"Predicción 3 meses"=2)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))

```
  \captionof{table}{Apple Inc.: valores optimizados para mtry y accuracy obtenida}
  
\setlength\parskip{5ex}

Como se puede apreciar en la tabla 6.2, para la empresa Apple Inc. la situación es diferente. Se obtienen, en general, mejores resultados que en el caso de la empresa Coca Cola. Para la predicción a 1 mes el mejor resultado se obtiene con un alisado utilizando EMA de 90 días con una *accuracy* del 87.30%. Para la predicción hecha a 2 meses el mejor resultado es un 69.84% de accuracy obtenido con un alisado EMA 90 días. Para el caso en el que la predicción es a 3 meses el mejor resultado es de un 73.81% de *accuracy* con un alisado de EMA 90 días. Es decir, en el caso de la empresa Apple Inc el mejor resultado global se obtiene prediciendo si la media móbil exponencial a 90 días del precio de cierre estará más alta o no a 1 meses vista. En este caso los mejores resultados se obtienen con una predicción hecha a 1 mes vista con los datos fuertemente alisados. El hecho de predecir si al cabo de un mes la media móbil exponencial del precio de cierre calculada con 90 días será más alta o no, es de ayuda para el inversor ya que significa que el precio de cierre al cabo de un mes será más alto. Esto se debe al hecho de que si la EMA 90 días será más alta al cabo de un mes significa que los precios de ese último mes han sido más altos.

```{r}
#AMerican express


a<-data.frame(mtry1m=as.numeric(c(which(errors_AXP_30_1m_target_feature==min(errors_AXP_30_1m_target_feature))[1],
                                    which(errors_AXP_60_1m_target_feature==min(errors_AXP_60_1m_target_feature[-1]))[1],
                                   which(errors_AXP_90_1m_target_feature==min(errors_AXP_90_1m_target_feature))[1],
                                   which(errors_AXP_fun_1m_target_feature==min(errors_AXP_fun_1m_target_feature))[2])),
              accuracy1m=as.numeric(c((1-min(errors_AXP_30_1m_target_feature))*100,
                                    (1-min(errors_AXP_60_1m_target_feature[-1]))*100,
                                    (1-min(errors_AXP_90_1m_target_feature))*100,
                                    (1-min(errors_AXP_fun_1m_target_feature))*100)),
              
              
              mtry2m=as.numeric(c(which(errors_AXP_30_2m_target_feature==min(errors_AXP_30_2m_target_feature[-1]))[1],
                                    which(errors_AXP_60_2m_target_feature==min(errors_AXP_60_2m_target_feature[-1]))[1],
                                   which(errors_AXP_90_2m_target_feature==min(errors_AXP_90_2m_target_feature))[1],
                                   which(errors_AXP_fun_2m_target_feature==min(errors_AXP_fun_2m_target_feature))[1])),
              
                 accuracy2m=as.numeric(c((1-min(errors_AXP_30_2m_target_feature[-1]))*100,
                                    (1-min(errors_AXP_60_2m_target_feature[-1]))*100,
                                    (1-min(errors_AXP_90_2m_target_feature))*100,
                                    (1-min(errors_AXP_fun_2m_target_feature))*100)),
              
              
              mtry3m=as.numeric(c(which(errors_AXP_30_3m_target_feature==min(errors_AXP_30_3m_target_feature[-1]))[1],
                                    which(errors_AXP_60_3m_target_feature==min(errors_AXP_60_3m_target_feature))[1],
                                   which(errors_AXP_90_3m_target_feature==min(errors_AXP_90_3m_target_feature))[2],
                                   which(errors_AXP_fun_3m_target_feature==min(errors_AXP_fun_3m_target_feature))[1])),
              
              accuracy3m=as.numeric(c((1-min(errors_AXP_30_3m_target_feature[-1]))*100,
                                    (1-min(errors_AXP_60_3m_target_feature))*100,
                                    (1-min(errors_AXP_90_3m_target_feature))*100,
                                    (1-min(errors_AXP_fun_3m_target_feature))*100))
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

kable(a, "latex") %>%
    add_header_above(c(" ", "Predicción 1 mes" = 2, "Predicción 2 meses" = 2,"Predicción 3 meses"=2)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))

```
  \captionof{table}{American Express CO.: valores optimizados para mtry y accuracy obtenida}
  
\setlength\parskip{5ex}

Los resultados obtenidos para la empresa American Express CO. son globalmente mejores en los casos en los que la predicción está hecha para el siguiente mes y para al cabo de 3 meses. Para el caso en el que la predicción se hace a 1 mes, el mejor resultado obtenido es de 79.76% de *accuracy* en la muestra de validación y se corresponde a un alisado de los datos utilizando la fórmula del alisado exponencial. A su vez se obtiene el mismo resultado con los datos alisados mediante una media móbil exponencial de 30 días. Para el caso en el que la predicción se hace a 2 meses el mejor resultado que se obtiene es de 59.92% de *accuracy* en el caso de alisar los datos con la fórmula del alisado exponencial. Este resultado es ligeramente superior al que se obtendría con una predicción aleatória (50%). El resultado que se obtiene en el caso de la predicción hecha a 3 meses ya que en el mejor de los casos, cuando se alisan los datos con una media móbil exponencial de 90 días, es de 80.16% de *accuracy* (mejor resultado global). Esto significa que, para esta empresa, la mejor clasificación se obtiene prediciendo si la EMA 90 días será más alta o no al cabo de 3 meses. En esencia, este caso de predicción representa que se está analizando si el incremento de los precios ha hecho que la media móbil exponencial haya subido los últimos 3 meses.

```{r}
#wells fargo


a<-data.frame(mtry1m=as.numeric(c(which(errors_WFC_30_1m_target_feature==min(errors_WFC_30_1m_target_feature))[1],
                                    which(errors_WFC_60_1m_target_feature==min(errors_WFC_60_1m_target_feature[-1]))[1],
                                   which(errors_WFC_90_1m_target_feature==min(errors_WFC_90_1m_target_feature[-1]))[1],
                                   which(errors_WFC_fun_1m_target_feature==min(errors_WFC_fun_1m_target_feature))[1])),
              accuracy1m=as.numeric(c((1-min(errors_WFC_30_1m_target_feature))*100,
                                    (1-min(errors_WFC_60_1m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_90_1m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_fun_1m_target_feature))*100)),
              
              
              mtry2m=as.numeric(c(which(errors_WFC_30_2m_target_feature==min(errors_WFC_30_2m_target_feature[-1]))[1],
                                    which(errors_WFC_60_2m_target_feature==min(errors_WFC_60_2m_target_feature[-1]))[1],
                                   which(errors_WFC_90_2m_target_feature==min(errors_WFC_90_2m_target_feature[-1]))[1],
                                   which(errors_WFC_fun_2m_target_feature==min(errors_WFC_fun_2m_target_feature))[1])),
              
                 accuracy2m=as.numeric(c((1-min(errors_WFC_30_2m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_60_2m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_90_2m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_fun_2m_target_feature))*100)),
              
              
              mtry3m=as.numeric(c(which(errors_WFC_30_3m_target_feature==min(errors_WFC_30_3m_target_feature[-1]))[1],
                                    which(errors_WFC_60_3m_target_feature==min(errors_WFC_60_3m_target_feature[-1]))[1],
                                   which(errors_WFC_90_3m_target_feature==min(errors_WFC_90_3m_target_feature[-1]))[1],
                                   which(errors_WFC_fun_3m_target_feature==min(errors_WFC_fun_3m_target_feature[-1]))[1])),
              
              accuracy3m=as.numeric(c((1-min(errors_WFC_30_3m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_60_3m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_90_3m_target_feature[-1]))*100,
                                    (1-min(errors_WFC_fun_3m_target_feature[-1]))*100))
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

kable(a, "latex") %>%
    add_header_above(c(" ", "Predicción 1 mes" = 2, "Predicción 2 meses" = 2,"Predicción 3 meses"=2)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))

```
  \captionof{table}{Wells Fargo and CO.: valores optimizados para mtry y accuracy obtenida}
  
\setlength\parskip{5ex}
En el caso de Wells Fargo & CO. los resultados sobre la muestra de validación se pueden observar en la tabla 6.4. Son, en general, peores que los resultados obtenidos con la empresa Apple Inc. y American Express CO.. Para la predicción hecha a 1 mes el mejor resultado se obtiene utilizando la fórmula de alisado exponencial (2) con una *accuracy* de 69.84% (mejor resultado global para esta empresa). Esto significa que sobre la muestra de validación aproximadamente el 70% de los casos queda bien clasificado. En el caso de la predicción a 2 meses el mejor resultado obtenido es de 58.33% de *accuracy* obtenido alisando los datos con la fórmula de alisado exponencial (2). El mejor resultadao cuando la predicción se hace a 3 meses vista es del 64.28% de *accuracy*.

HACER AQUI EL HEATMAP DE LOS ERRORES OBTENIDOS DE CROSSVALIDACION


*Resultados sobre muestra test*

Una vez optimizados los valores del hyper parámetro `mtry` se entrenan los modelos con las muestras de entrenamiento + validación con el objetivo de testar el modelo con los datos de test. En total se construyen 48 modelos: 4 por cada tipo de variable respuesta y, a su vez, 4 por cada empresa. En las tablas siguientes se muestran los valores de *accuracy*, *sensitivity* y *specificity* de los distintos modelos sobre los datos test.

<!-- <!-- models --> 
<!-- ```{r} -->
<!-- #KO models -->
<!-- train_vali_KO_30_1m<- -->
<!--   train_KO_30_1m_target_feature %>% bind_rows(validation_KO_30_1m_target_feature) -->
<!--       rownames(train_vali_KO_30_1m)<-c(rownames(train_KO_30_1m_target_feature),rownames(validation_KO_30_1m_target_feature)) -->

<!-- train_vali_KO_60_1m<- -->
<!--   train_KO_60_1m_target_feature %>% bind_rows(validation_KO_60_1m_target_feature) -->
<!--       rownames(train_vali_KO_60_1m)<-c(rownames(train_KO_60_1m_target_feature),rownames(validation_KO_60_1m_target_feature)) -->

<!-- train_vali_KO_90_1m<- -->
<!--   train_KO_90_1m_target_feature %>% bind_rows(validation_KO_90_1m_target_feature) -->
<!--         rownames(train_vali_KO_90_1m)<-c(rownames(train_KO_90_1m_target_feature),rownames(validation_KO_90_1m_target_feature)) -->

<!-- train_vali_KO_fun_1m<- -->
<!--   train_KO_fun_1m_target_feature %>% bind_rows(validation_KO_fun_1m_target_feature) -->
<!--         rownames(train_vali_KO_fun_1m)<-c(rownames(train_KO_fun_1m_target_feature),rownames(validation_KO_fun_1m_target_feature)) -->


<!--         train_vali_KO_30_2m<- -->
<!--   train_KO_30_2m_target_feature %>% bind_rows(validation_KO_30_2m_target_feature) -->
<!--       rownames(train_vali_KO_30_2m)<-c(rownames(train_KO_30_2m_target_feature),rownames(validation_KO_30_2m_target_feature)) -->

<!-- train_vali_KO_60_2m<- -->
<!--   train_KO_60_2m_target_feature %>% bind_rows(validation_KO_60_2m_target_feature) -->
<!--       rownames(train_vali_KO_60_2m)<-c(rownames(train_KO_60_2m_target_feature),rownames(validation_KO_60_2m_target_feature)) -->

<!-- train_vali_KO_90_2m<- -->
<!--   train_KO_90_2m_target_feature %>% bind_rows(validation_KO_90_2m_target_feature) -->
<!--         rownames(train_vali_KO_90_2m)<-c(rownames(train_KO_90_2m_target_feature),rownames(validation_KO_90_2m_target_feature)) -->

<!--         train_vali_KO_fun_2m<- -->
<!--   train_KO_fun_2m_target_feature %>% bind_rows(validation_KO_fun_2m_target_feature) -->
<!--         rownames(train_vali_KO_fun_2m)<-c(rownames(train_KO_fun_2m_target_feature),rownames(validation_KO_fun_2m_target_feature)) -->

<!--         train_vali_KO_30_3m<- -->
<!--   train_KO_30_3m_target_feature %>% bind_rows(validation_KO_30_3m_target_feature) -->
<!--       rownames(train_vali_KO_30_3m)<-c(rownames(train_KO_30_3m_target_feature),rownames(validation_KO_30_3m_target_feature)) -->

<!-- train_vali_KO_60_3m<- -->
<!--   train_KO_60_3m_target_feature %>% bind_rows(validation_KO_60_3m_target_feature) -->
<!--       rownames(train_vali_KO_60_3m)<-c(rownames(train_KO_60_3m_target_feature),rownames(validation_KO_60_3m_target_feature)) -->

<!-- train_vali_KO_90_3m<- -->
<!--   train_KO_90_3m_target_feature %>% bind_rows(validation_KO_90_3m_target_feature) -->
<!--         rownames(train_vali_KO_90_3m)<-c(rownames(train_KO_90_3m_target_feature),rownames(validation_KO_90_3m_target_feature)) -->

<!--         train_vali_KO_fun_3m<- -->
<!--   train_KO_fun_3m_target_feature %>% bind_rows(validation_KO_fun_3m_target_feature) -->
<!--         rownames(train_vali_KO_fun_3m)<-c(rownames(train_KO_fun_3m_target_feature),rownames(validation_KO_fun_3m_target_feature)) -->

<!-- model_KO_30_1m_target_feature<-randomForest(target~.,data=train_vali_KO_30_1m,mtry=13) -->
<!-- model_KO_60_1m_target_feature<-randomForest(target~.,data=train_vali_KO_60_1m,mtry=2) -->
<!-- model_KO_90_1m_target_feature<-randomForest(target~.,data=train_vali_KO_90_1m,mtry=2) -->
<!-- model_KO_fun_1m_target_feature<-randomForest(target~.,data=train_vali_KO_fun_1m,mtry=2) -->

<!-- model_KO_30_2m_target_feature<-randomForest(target~.,data=train_vali_KO_30_2m,mtry=2) -->
<!-- model_KO_60_2m_target_feature<-randomForest(target~.,data=train_vali_KO_60_2m,mtry=2) -->
<!-- model_KO_90_2m_target_feature<-randomForest(target~.,data=train_vali_KO_90_2m,mtry=4) -->
<!-- model_KO_fun_2m_target_feature<-randomForest(target~.,data=train_vali_KO_fun_2m,mtry=16) -->

<!-- model_KO_30_3m_target_feature<-randomForest(target~.,data=train_vali_KO_30_3m,mtry=2) -->
<!-- model_KO_60_3m_target_feature<-randomForest(target~.,data=train_vali_KO_60_3m,mtry=2) -->
<!-- model_KO_90_3m_target_feature<-randomForest(target~.,data=train_vali_KO_90_3m,mtry=2) -->
<!-- model_KO_fun_3m_target_feature<-randomForest(target~.,data=train_vali_KO_fun_3m,mtry=3) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- #AAPL models -->
<!-- train_vali_AAPL_30_1m<- -->
<!--   train_AAPL_30_1m_target_feature %>% bind_rows(validation_AAPL_30_1m_target_feature) -->
<!--       rownames(train_vali_AAPL_30_1m)<-c(rownames(train_AAPL_30_1m_target_feature),rownames(validation_AAPL_30_1m_target_feature)) -->

<!-- train_vali_AAPL_60_1m<- -->
<!--   train_AAPL_60_1m_target_feature %>% bind_rows(validation_AAPL_60_1m_target_feature) -->
<!--       rownames(train_vali_AAPL_60_1m)<-c(rownames(train_AAPL_60_1m_target_feature),rownames(validation_AAPL_60_1m_target_feature)) -->

<!-- train_vali_AAPL_90_1m<- -->
<!--   train_AAPL_90_1m_target_feature %>% bind_rows(validation_AAPL_90_1m_target_feature) -->
<!--         rownames(train_vali_AAPL_90_1m)<-c(rownames(train_AAPL_90_1m_target_feature),rownames(validation_AAPL_90_1m_target_feature)) -->

<!-- train_vali_AAPL_fun_1m<- -->
<!--   train_AAPL_fun_1m_target_feature %>% bind_rows(validation_AAPL_fun_1m_target_feature) -->
<!--         rownames(train_vali_AAPL_fun_1m)<-c(rownames(train_AAPL_fun_1m_target_feature),rownames(validation_AAPL_fun_1m_target_feature)) -->


<!--         train_vali_AAPL_30_2m<- -->
<!--   train_AAPL_30_2m_target_feature %>% bind_rows(validation_AAPL_30_2m_target_feature) -->
<!--       rownames(train_vali_AAPL_30_2m)<-c(rownames(train_AAPL_30_2m_target_feature),rownames(validation_AAPL_30_2m_target_feature)) -->

<!-- train_vali_AAPL_60_2m<- -->
<!--   train_AAPL_60_2m_target_feature %>% bind_rows(validation_AAPL_60_2m_target_feature) -->
<!--       rownames(train_vali_AAPL_60_2m)<-c(rownames(train_AAPL_60_2m_target_feature),rownames(validation_AAPL_60_2m_target_feature)) -->

<!-- train_vali_AAPL_90_2m<- -->
<!--   train_AAPL_90_2m_target_feature %>% bind_rows(validation_AAPL_90_2m_target_feature) -->
<!--         rownames(train_vali_AAPL_90_2m)<-c(rownames(train_AAPL_90_2m_target_feature),rownames(validation_AAPL_90_2m_target_feature)) -->

<!--         train_vali_AAPL_fun_2m<- -->
<!--   train_AAPL_fun_2m_target_feature %>% bind_rows(validation_AAPL_fun_2m_target_feature) -->
<!--         rownames(train_vali_AAPL_fun_2m)<-c(rownames(train_AAPL_fun_2m_target_feature),rownames(validation_AAPL_fun_2m_target_feature)) -->

<!--         train_vali_AAPL_30_3m<- -->
<!--   train_AAPL_30_3m_target_feature %>% bind_rows(validation_AAPL_30_3m_target_feature) -->
<!--       rownames(train_vali_AAPL_30_3m)<-c(rownames(train_AAPL_30_3m_target_feature),rownames(validation_AAPL_30_3m_target_feature)) -->

<!-- train_vali_AAPL_60_3m<- -->
<!--   train_AAPL_60_3m_target_feature %>% bind_rows(validation_AAPL_60_3m_target_feature) -->
<!--       rownames(train_vali_AAPL_60_3m)<-c(rownames(train_AAPL_60_3m_target_feature),rownames(validation_AAPL_60_3m_target_feature)) -->

<!-- train_vali_AAPL_90_3m<- -->
<!--   train_AAPL_90_3m_target_feature %>% bind_rows(validation_AAPL_90_3m_target_feature) -->
<!--         rownames(train_vali_AAPL_90_3m)<-c(rownames(train_AAPL_90_3m_target_feature),rownames(validation_AAPL_90_3m_target_feature)) -->

<!--         train_vali_AAPL_fun_3m<- -->
<!--   train_AAPL_fun_3m_target_feature %>% bind_rows(validation_AAPL_fun_3m_target_feature) -->
<!--         rownames(train_vali_AAPL_fun_3m)<-c(rownames(train_AAPL_fun_3m_target_feature),rownames(validation_AAPL_fun_3m_target_feature)) -->

<!-- model_AAPL_30_1m_target_feature<-randomForest(target~.,data=train_vali_AAPL_30_1m,mtry=29) -->
<!-- model_AAPL_60_1m_target_feature<-randomForest(target~.,data=train_vali_AAPL_60_1m,mtry=26) -->
<!-- model_AAPL_90_1m_target_feature<-randomForest(target~.,data=train_vali_AAPL_90_1m,mtry=28) -->
<!-- model_AAPL_fun_1m_target_feature<-randomForest(target~.,data=train_vali_AAPL_fun_1m,mtry=27) -->

<!-- model_AAPL_30_2m_target_feature<-randomForest(target~.,data=train_vali_AAPL_30_2m,mtry=11) -->
<!-- model_AAPL_60_2m_target_feature<-randomForest(target~.,data=train_vali_AAPL_60_2m,mtry=2) -->
<!-- model_AAPL_90_2m_target_feature<-randomForest(target~.,data=train_vali_AAPL_90_2m,mtry=2) -->
<!-- model_AAPL_fun_2m_target_feature<-randomForest(target~.,data=train_vali_AAPL_fun_2m,mtry=11) -->

<!-- model_AAPL_30_3m_target_feature<-randomForest(target~.,data=train_vali_AAPL_30_3m,mtry=14) -->
<!-- model_AAPL_60_3m_target_feature<-randomForest(target~.,data=train_vali_AAPL_60_3m,mtry=23) -->
<!-- model_AAPL_90_3m_target_feature<-randomForest(target~.,data=train_vali_AAPL_90_3m,mtry=18) -->
<!-- model_AAPL_fun_3m_target_feature<-randomForest(target~.,data=train_vali_AAPL_fun_3m,mtry=11) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- #AXP models -->
<!-- train_vali_AXP_30_1m<- -->
<!--   train_AXP_30_1m_target_feature %>% bind_rows(validation_AXP_30_1m_target_feature) -->
<!--       rownames(train_vali_AXP_30_1m)<-c(rownames(train_AXP_30_1m_target_feature),rownames(validation_AXP_30_1m_target_feature)) -->

<!-- train_vali_AXP_60_1m<- -->
<!--   train_AXP_60_1m_target_feature %>% bind_rows(validation_AXP_60_1m_target_feature) -->
<!--       rownames(train_vali_AXP_60_1m)<-c(rownames(train_AXP_60_1m_target_feature),rownames(validation_AXP_60_1m_target_feature)) -->

<!-- train_vali_AXP_90_1m<- -->
<!--   train_AXP_90_1m_target_feature %>% bind_rows(validation_AXP_90_1m_target_feature) -->
<!--         rownames(train_vali_AXP_90_1m)<-c(rownames(train_AXP_90_1m_target_feature),rownames(validation_AXP_90_1m_target_feature)) -->

<!-- train_vali_AXP_fun_1m<- -->
<!--   train_AXP_fun_1m_target_feature %>% bind_rows(validation_AXP_fun_1m_target_feature) -->
<!--         rownames(train_vali_AXP_fun_1m)<-c(rownames(train_AXP_fun_1m_target_feature),rownames(validation_AXP_fun_1m_target_feature)) -->


<!--         train_vali_AXP_30_2m<- -->
<!--   train_AXP_30_2m_target_feature %>% bind_rows(validation_AXP_30_2m_target_feature) -->
<!--       rownames(train_vali_AXP_30_2m)<-c(rownames(train_AXP_30_2m_target_feature),rownames(validation_AXP_30_2m_target_feature)) -->

<!-- train_vali_AXP_60_2m<- -->
<!--   train_AXP_60_2m_target_feature %>% bind_rows(validation_AXP_60_2m_target_feature) -->
<!--       rownames(train_vali_AXP_60_2m)<-c(rownames(train_AXP_60_2m_target_feature),rownames(validation_AXP_60_2m_target_feature)) -->

<!-- train_vali_AXP_90_2m<- -->
<!--   train_AXP_90_2m_target_feature %>% bind_rows(validation_AXP_90_2m_target_feature) -->
<!--         rownames(train_vali_AXP_90_2m)<-c(rownames(train_AXP_90_2m_target_feature),rownames(validation_AXP_90_2m_target_feature)) -->

<!--         train_vali_AXP_fun_2m<- -->
<!--   train_AXP_fun_2m_target_feature %>% bind_rows(validation_AXP_fun_2m_target_feature) -->
<!--         rownames(train_vali_AXP_fun_2m)<-c(rownames(train_AXP_fun_2m_target_feature),rownames(validation_AXP_fun_2m_target_feature)) -->

<!--         train_vali_AXP_30_3m<- -->
<!--   train_AXP_30_3m_target_feature %>% bind_rows(validation_AXP_30_3m_target_feature) -->
<!--       rownames(train_vali_AXP_30_3m)<-c(rownames(train_AXP_30_3m_target_feature),rownames(validation_AXP_30_3m_target_feature)) -->

<!-- train_vali_AXP_60_3m<- -->
<!--   train_AXP_60_3m_target_feature %>% bind_rows(validation_AXP_60_3m_target_feature) -->
<!--       rownames(train_vali_AXP_60_3m)<-c(rownames(train_AXP_60_3m_target_feature),rownames(validation_AXP_60_3m_target_feature)) -->

<!-- train_vali_AXP_90_3m<- -->
<!--   train_AXP_90_3m_target_feature %>% bind_rows(validation_AXP_90_3m_target_feature) -->
<!--         rownames(train_vali_AXP_90_3m)<-c(rownames(train_AXP_90_3m_target_feature),rownames(validation_AXP_90_3m_target_feature)) -->

<!--         train_vali_AXP_fun_3m<- -->
<!--   train_AXP_fun_3m_target_feature %>% bind_rows(validation_AXP_fun_3m_target_feature) -->
<!--         rownames(train_vali_AXP_fun_3m)<-c(rownames(train_AXP_fun_3m_target_feature),rownames(validation_AXP_fun_3m_target_feature)) -->

<!-- model_AXP_30_1m_target_feature<-randomForest(target~.,data=train_vali_AXP_30_1m,mtry=9) -->
<!-- model_AXP_60_1m_target_feature<-randomForest(target~.,data=train_vali_AXP_60_1m,mtry=2) -->
<!-- model_AXP_90_1m_target_feature<-randomForest(target~.,data=train_vali_AXP_90_1m,mtry=10) -->
<!-- model_AXP_fun_1m_target_feature<-randomForest(target~.,data=train_vali_AXP_fun_1m,mtry=2) -->

<!-- model_AXP_30_2m_target_feature<-randomForest(target~.,data=train_vali_AXP_30_2m,mtry=2) -->
<!-- model_AXP_60_2m_target_feature<-randomForest(target~.,data=train_vali_AXP_60_2m,mtry=2) -->
<!-- model_AXP_90_2m_target_feature<-randomForest(target~.,data=train_vali_AXP_90_2m,mtry=31) -->
<!-- model_AXP_fun_2m_target_feature<-randomForest(target~.,data=train_vali_AXP_fun_2m,mtry=3) -->

<!-- model_AXP_30_3m_target_feature<-randomForest(target~.,data=train_vali_AXP_30_3m,mtry=2) -->
<!-- model_AXP_60_3m_target_feature<-randomForest(target~.,data=train_vali_AXP_60_3m,mtry=5) -->
<!-- model_AXP_90_3m_target_feature<-randomForest(target~.,data=train_vali_AXP_90_3m,mtry=2) -->
<!-- model_AXP_fun_3m_target_feature<-randomForest(target~.,data=train_vali_AXP_fun_3m,mtry=4) -->

<!-- ``` -->

<!-- ```{r} -->
<!-- #WFC models -->
<!-- train_vali_WFC_30_1m<- -->
<!--   train_WFC_30_1m_target_feature %>% bind_rows(validation_WFC_30_1m_target_feature) -->
<!--       rownames(train_vali_WFC_30_1m)<-c(rownames(train_WFC_30_1m_target_feature),rownames(validation_WFC_30_1m_target_feature)) -->

<!-- train_vali_WFC_60_1m<- -->
<!--   train_WFC_60_1m_target_feature %>% bind_rows(validation_WFC_60_1m_target_feature) -->
<!--       rownames(train_vali_WFC_60_1m)<-c(rownames(train_WFC_60_1m_target_feature),rownames(validation_WFC_60_1m_target_feature)) -->
<!--       train_vali_WFC_60_1m$PNratio[train_vali_WFC_60_1m$PNratio==Inf]<-1 -->

<!-- train_vali_WFC_90_1m<- -->
<!--   train_WFC_90_1m_target_feature %>% bind_rows(validation_WFC_90_1m_target_feature) -->
<!--         rownames(train_vali_WFC_90_1m)<-c(rownames(train_WFC_90_1m_target_feature),rownames(validation_WFC_90_1m_target_feature)) -->

<!-- train_vali_WFC_fun_1m<- -->
<!--   train_WFC_fun_1m_target_feature %>% bind_rows(validation_WFC_fun_1m_target_feature) -->
<!--         rownames(train_vali_WFC_fun_1m)<-c(rownames(train_WFC_fun_1m_target_feature),rownames(validation_WFC_fun_1m_target_feature)) -->


<!--         train_vali_WFC_30_2m<- -->
<!--   train_WFC_30_2m_target_feature %>% bind_rows(validation_WFC_30_2m_target_feature) -->
<!--       rownames(train_vali_WFC_30_2m)<-c(rownames(train_WFC_30_2m_target_feature),rownames(validation_WFC_30_2m_target_feature)) -->

<!-- train_vali_WFC_60_2m<- -->
<!--   train_WFC_60_2m_target_feature %>% bind_rows(validation_WFC_60_2m_target_feature) -->
<!--       rownames(train_vali_WFC_60_2m)<-c(rownames(train_WFC_60_2m_target_feature),rownames(validation_WFC_60_2m_target_feature)) -->

<!-- train_vali_WFC_90_2m<- -->
<!--   train_WFC_90_2m_target_feature %>% bind_rows(validation_WFC_90_2m_target_feature) -->
<!--         rownames(train_vali_WFC_90_2m)<-c(rownames(train_WFC_90_2m_target_feature),rownames(validation_WFC_90_2m_target_feature)) -->

<!--         train_vali_WFC_fun_2m<- -->
<!--   train_WFC_fun_2m_target_feature %>% bind_rows(validation_WFC_fun_2m_target_feature) -->
<!--         rownames(train_vali_WFC_fun_2m)<-c(rownames(train_WFC_fun_2m_target_feature),rownames(validation_WFC_fun_2m_target_feature)) -->

<!--         train_vali_WFC_30_3m<- -->
<!--   train_WFC_30_3m_target_feature %>% bind_rows(validation_WFC_30_3m_target_feature) -->
<!--       rownames(train_vali_WFC_30_3m)<-c(rownames(train_WFC_30_3m_target_feature),rownames(validation_WFC_30_3m_target_feature)) -->

<!-- train_vali_WFC_60_3m<- -->
<!--   train_WFC_60_3m_target_feature %>% bind_rows(validation_WFC_60_3m_target_feature) -->
<!--       rownames(train_vali_WFC_60_3m)<-c(rownames(train_WFC_60_3m_target_feature),rownames(validation_WFC_60_3m_target_feature)) -->

<!-- train_vali_WFC_90_3m<- -->
<!--   train_WFC_90_3m_target_feature %>% bind_rows(validation_WFC_90_3m_target_feature) -->
<!--         rownames(train_vali_WFC_90_3m)<-c(rownames(train_WFC_90_3m_target_feature),rownames(validation_WFC_90_3m_target_feature)) -->

<!--         train_vali_WFC_fun_3m<- -->
<!--   train_WFC_fun_3m_target_feature %>% bind_rows(validation_WFC_fun_3m_target_feature) -->
<!--         rownames(train_vali_WFC_fun_3m)<-c(rownames(train_WFC_fun_3m_target_feature),rownames(validation_WFC_fun_3m_target_feature)) -->

<!-- model_WFC_30_1m_target_feature<-randomForest(target~.,data=train_vali_WFC_30_1m,mtry=4) -->
<!-- model_WFC_60_1m_target_feature<-randomForest(target~.,data=train_vali_WFC_60_1m,mtry=3) -->
<!-- model_WFC_90_1m_target_feature<-randomForest(target~.,data=train_vali_WFC_90_1m,mtry=3) -->
<!-- model_WFC_fun_1m_target_feature<-randomForest(target~.,data=train_vali_WFC_fun_1m,mtry=4) -->

<!-- model_WFC_30_2m_target_feature<-randomForest(target~.,data=train_vali_WFC_30_2m,mtry=2) -->

<!-- train_vali_WFC_60_2m$PNratio[train_vali_WFC_60_2m$PNratio==Inf]<-1 -->
<!-- model_WFC_60_2m_target_feature<-randomForest(target~.,data=train_vali_WFC_60_2m,mtry=2) -->
<!-- model_WFC_90_2m_target_feature<-randomForest(target~.,data=train_vali_WFC_90_2m,mtry=2) -->
<!-- model_WFC_fun_2m_target_feature<-randomForest(target~.,data=train_vali_WFC_fun_2m,mtry=3) -->

<!-- model_WFC_30_3m_target_feature<-randomForest(target~.,data=train_vali_WFC_30_3m,mtry=2) -->

<!-- train_vali_WFC_60_3m$PNratio[train_vali_WFC_60_3m$PNratio==Inf]<-1 -->
<!-- model_WFC_60_3m_target_feature<-randomForest(target~.,data=train_vali_WFC_60_3m,mtry=2) -->
<!-- model_WFC_90_3m_target_feature<-randomForest(target~.,data=train_vali_WFC_90_3m,mtry=13) -->
<!-- model_WFC_fun_3m_target_feature<-randomForest(target~.,data=train_vali_WFC_fun_3m,mtry=3) -->

<!-- ``` -->

```{r}
load("C:/Users/i0386388/Desktop/tesis/datasplit_testmodels.RData")
```

<!-- confusion matrix -->

```{r ConfusionMatrixKO}
CM_KO_30_1m<-confusionMatrix(predict(model_KO_30_1m_target_feature,test_KO_30_1m_target_feature),test_KO_30_1m_target_feature$target)
CM_KO_60_1m<-confusionMatrix(predict(model_KO_60_1m_target_feature,test_KO_60_1m_target_feature),test_KO_60_1m_target_feature$target)
CM_KO_90_1m<-confusionMatrix(predict(model_KO_90_1m_target_feature,test_KO_90_1m_target_feature),test_KO_90_1m_target_feature$target)
CM_KO_fun_1m<-confusionMatrix(predict(model_KO_fun_1m_target_feature,test_KO_fun_1m_target_feature),test_KO_fun_1m_target_feature$target)


CM_KO_30_2m<-confusionMatrix(predict(model_KO_30_2m_target_feature,test_KO_30_2m_target_feature),test_KO_30_2m_target_feature$target)
CM_KO_60_2m<-confusionMatrix(predict(model_KO_60_2m_target_feature,test_KO_60_2m_target_feature),test_KO_60_2m_target_feature$target)
CM_KO_90_2m<-confusionMatrix(predict(model_KO_90_2m_target_feature,test_KO_90_2m_target_feature),test_KO_90_2m_target_feature$target)
CM_KO_fun_2m<-confusionMatrix(predict(model_KO_fun_2m_target_feature,test_KO_fun_2m_target_feature),test_KO_fun_2m_target_feature$target)

CM_KO_30_3m<-confusionMatrix(predict(model_KO_30_3m_target_feature,test_KO_30_3m_target_feature),test_KO_30_3m_target_feature$target)
CM_KO_60_3m<-confusionMatrix(predict(model_KO_60_3m_target_feature,test_KO_60_3m_target_feature),test_KO_60_3m_target_feature$target)
CM_KO_90_3m<-confusionMatrix(predict(model_KO_90_3m_target_feature,test_KO_90_3m_target_feature),test_KO_90_3m_target_feature$target)
CM_KO_fun_3m<-confusionMatrix(predict(model_KO_fun_3m_target_feature,test_KO_fun_3m_target_feature),test_KO_fun_3m_target_feature$target)


a<-data.frame(acc1m=as.numeric(c(round(CM_KO_30_1m$overall[1]*100,2),
                                    round(CM_KO_60_1m$overall[1]*100,2),
                                   round(CM_KO_90_1m$overall[1]*100,2),
                                   round(CM_KO_fun_1m$overall[1]*100,2))),
              sensi1m=as.numeric(c(round(CM_KO_30_1m$byClass[1]*100,2),
                                    round(CM_KO_60_1m$byClass[1]*100,2),
                                    round(CM_KO_90_1m$byClass[1]*100,2),
                                    round(CM_KO_fun_1m$byClass[1]*100,2))),
              speci1m=as.numeric(c(round(CM_KO_30_1m$byClass[2]*100,2),
                                    round(CM_KO_60_1m$byClass[2]*100,2),
                                    round(CM_KO_90_1m$byClass[2]*100,2),
                                    round(CM_KO_fun_1m$byClass[2]*100,2))),
              
              acc2m=as.numeric(c(round(CM_KO_30_2m$overall[1]*100,2),
                                    round(CM_KO_60_2m$overall[1]*100,2),
                                   round(CM_KO_90_2m$overall[1]*100,2),
                                   round(CM_KO_fun_2m$overall[1]*100,2))),
              sensi2m=as.numeric(c(round(CM_KO_30_2m$byClass[1]*100,2),
                                    round(CM_KO_60_2m$byClass[1]*100,2),
                                    round(CM_KO_90_2m$byClass[1]*100,2),
                                    round(CM_KO_fun_2m$byClass[1]*100,2))),
              speci2m=as.numeric(c(round(CM_KO_30_2m$byClass[2]*100,2),
                                    round(CM_KO_60_2m$byClass[2]*100,2),
                                    round(CM_KO_90_2m$byClass[2]*100,2),
                                    round(CM_KO_fun_2m$byClass[2]*100,2))),
              
              acc3m=as.numeric(c(round(CM_KO_30_3m$overall[1]*100,2),
                                    round(CM_KO_60_3m$overall[1]*100,2),
                                   round(CM_KO_90_3m$overall[1]*100,2),
                                   round(CM_KO_fun_3m$overall[1]*100,2))),
              sensi3m=as.numeric(c(round(CM_KO_30_3m$byClass[1]*100,2),
                                    round(CM_KO_60_3m$byClass[1]*100,2),
                                    round(CM_KO_90_3m$byClass[1]*100,2),
                                    round(CM_KO_fun_3m$byClass[1]*100,2))),
              speci3m=as.numeric(c(round(CM_KO_30_3m$byClass[2]*100,2),
                                    round(CM_KO_60_3m$byClass[2]*100,2),
                                    round(CM_KO_90_3m$byClass[2]*100,2),
                                    round(CM_KO_fun_3m$byClass[2]*100,2)))
              
              
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

ConfusionKO<-a
SensiKO<-ConfusionKO[,grep(x=names(ConfusionKO), pattern="sensi")]
SpeciKO<-ConfusionKO[,grep(x=names(ConfusionKO), pattern="speci")]
ConfusionKO<-ConfusionKO[,grep(x=names(ConfusionKO), pattern="acc")]

kable(a, "latex") %>%
  add_header_above(c(" ", "Predicción 1 mes" = 3, "Predicción 2 meses" = 3,"Predicción 3 meses"=3)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))


```
  \captionof{table}{Coca Cola CO.: Metricas de rendimiento sobre muestra test}
  
\setlength\parskip{5ex}

```{r ConfusionMatrixAAPL}
CM_AAPL_30_1m<-confusionMatrix(predict(model_AAPL_30_1m_target_feature,test_AAPL_30_1m_target_feature),test_AAPL_30_1m_target_feature$target)
CM_AAPL_60_1m<-confusionMatrix(predict(model_AAPL_60_1m_target_feature,test_AAPL_60_1m_target_feature),test_AAPL_60_1m_target_feature$target)
CM_AAPL_90_1m<-confusionMatrix(predict(model_AAPL_90_1m_target_feature,test_AAPL_90_1m_target_feature),test_AAPL_90_1m_target_feature$target)
CM_AAPL_fun_1m<-confusionMatrix(predict(model_AAPL_fun_1m_target_feature,test_AAPL_fun_1m_target_feature),test_AAPL_fun_1m_target_feature$target)


CM_AAPL_30_2m<-confusionMatrix(predict(model_AAPL_30_2m_target_feature,test_AAPL_30_2m_target_feature),test_AAPL_30_2m_target_feature$target)
CM_AAPL_60_2m<-confusionMatrix(predict(model_AAPL_60_2m_target_feature,test_AAPL_60_2m_target_feature),test_AAPL_60_2m_target_feature$target)
CM_AAPL_90_2m<-confusionMatrix(predict(model_AAPL_90_2m_target_feature,test_AAPL_90_2m_target_feature),test_AAPL_90_2m_target_feature$target)
CM_AAPL_fun_2m<-confusionMatrix(predict(model_AAPL_fun_2m_target_feature,test_AAPL_fun_2m_target_feature),test_AAPL_fun_2m_target_feature$target)

CM_AAPL_30_3m<-confusionMatrix(predict(model_AAPL_30_3m_target_feature,test_AAPL_30_3m_target_feature),test_AAPL_30_3m_target_feature$target)
CM_AAPL_60_3m<-confusionMatrix(predict(model_AAPL_60_3m_target_feature,test_AAPL_60_3m_target_feature),test_AAPL_60_3m_target_feature$target)
CM_AAPL_90_3m<-confusionMatrix(predict(model_AAPL_90_3m_target_feature,test_AAPL_90_3m_target_feature),test_AAPL_90_3m_target_feature$target)
CM_AAPL_fun_3m<-confusionMatrix(predict(model_AAPL_fun_3m_target_feature,test_AAPL_fun_3m_target_feature),test_AAPL_fun_3m_target_feature$target)


a<-data.frame(acc1m=as.numeric(c(round(CM_AAPL_30_1m$overall[1]*100,2),
                                    round(CM_AAPL_60_1m$overall[1]*100,2),
                                   round(CM_AAPL_90_1m$overall[1]*100,2),
                                   round(CM_AAPL_fun_1m$overall[1]*100,2))),
              sensi1m=as.numeric(c(round(CM_AAPL_30_1m$byClass[1]*100,2),
                                    round(CM_AAPL_60_1m$byClass[1]*100,2),
                                    round(CM_AAPL_90_1m$byClass[1]*100,2),
                                    round(CM_AAPL_fun_1m$byClass[1]*100,2))),
              speci1m=as.numeric(c(round(CM_AAPL_30_1m$byClass[2]*100,2),
                                    round(CM_AAPL_60_1m$byClass[2]*100,2),
                                    round(CM_AAPL_90_1m$byClass[2]*100,2),
                                    round(CM_AAPL_fun_1m$byClass[2]*100,2))),
              
              acc2m=as.numeric(c(round(CM_AAPL_30_2m$overall[1]*100,2),
                                    round(CM_AAPL_60_2m$overall[1]*100,2),
                                   round(CM_AAPL_90_2m$overall[1]*100,2),
                                   round(CM_AAPL_fun_2m$overall[1]*100,2))),
              sensi2m=as.numeric(c(round(CM_AAPL_30_2m$byClass[1]*100,2),
                                    round(CM_AAPL_60_2m$byClass[1]*100,2),
                                    round(CM_AAPL_90_2m$byClass[1]*100,2),
                                    round(CM_AAPL_fun_2m$byClass[1]*100,2))),
              speci2m=as.numeric(c(round(CM_AAPL_30_2m$byClass[2]*100,2),
                                    round(CM_AAPL_60_2m$byClass[2]*100,2),
                                    round(CM_AAPL_90_2m$byClass[2]*100,2),
                                    round(CM_AAPL_fun_2m$byClass[2]*100,2))),
              
              acc3m=as.numeric(c(round(CM_AAPL_30_3m$overall[1]*100,2),
                                    round(CM_AAPL_60_3m$overall[1]*100,2),
                                   round(CM_AAPL_90_3m$overall[1]*100,2),
                                   round(CM_AAPL_fun_3m$overall[1]*100,2))),
              sensi3m=as.numeric(c(round(CM_AAPL_30_3m$byClass[1]*100,2),
                                    round(CM_AAPL_60_3m$byClass[1]*100,2),
                                    round(CM_AAPL_90_3m$byClass[1]*100,2),
                                    round(CM_AAPL_fun_3m$byClass[1]*100,2))),
              speci3m=as.numeric(c(round(CM_AAPL_30_3m$byClass[2]*100,2),
                                    round(CM_AAPL_60_3m$byClass[2]*100,2),
                                    round(CM_AAPL_90_3m$byClass[2]*100,2),
                                    round(CM_AAPL_fun_3m$byClass[2]*100,2)))
              
              
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")
ConfusionAAPL<-a
SensiAAPL<-ConfusionAAPL[,grep(x=names(ConfusionAAPL), pattern="sensi")]
SpeciAAPL<-ConfusionAAPL[,grep(x=names(ConfusionAAPL), pattern="speci")]
ConfusionAAPL<-ConfusionAAPL[,grep(x=names(ConfusionAAPL), pattern="acc")]


kable(a, "latex") %>%
  add_header_above(c(" ", "Predicción 1 mes" = 3, "Predicción 2 meses" = 3,"Predicción 3 meses"=3)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))
```
  \captionof{table}{Apple Inc.: Metricas de rendimiento sobre muestra test}
  
\setlength\parskip{5ex}

```{r ConfusionMatrixAXP}
CM_AXP_30_1m<-confusionMatrix(predict(model_AXP_30_1m_target_feature,test_AXP_30_1m_target_feature),test_AXP_30_1m_target_feature$target)
CM_AXP_60_1m<-confusionMatrix(predict(model_AXP_60_1m_target_feature,test_AXP_60_1m_target_feature),test_AXP_60_1m_target_feature$target)
CM_AXP_90_1m<-confusionMatrix(predict(model_AXP_90_1m_target_feature,test_AXP_90_1m_target_feature),test_AXP_90_1m_target_feature$target)
CM_AXP_fun_1m<-confusionMatrix(predict(model_AXP_fun_1m_target_feature,test_AXP_fun_1m_target_feature),test_AXP_fun_1m_target_feature$target)


CM_AXP_30_2m<-confusionMatrix(predict(model_AXP_30_2m_target_feature,test_AXP_30_2m_target_feature),test_AXP_30_2m_target_feature$target)
CM_AXP_60_2m<-confusionMatrix(predict(model_AXP_60_2m_target_feature,test_AXP_60_2m_target_feature),test_AXP_60_2m_target_feature$target)
CM_AXP_90_2m<-confusionMatrix(predict(model_AXP_90_2m_target_feature,test_AXP_90_2m_target_feature),test_AXP_90_2m_target_feature$target)
CM_AXP_fun_2m<-confusionMatrix(predict(model_AXP_fun_2m_target_feature,test_AXP_fun_2m_target_feature),test_AXP_fun_2m_target_feature$target)

CM_AXP_30_3m<-confusionMatrix(predict(model_AXP_30_3m_target_feature,test_AXP_30_3m_target_feature),test_AXP_30_3m_target_feature$target)
CM_AXP_60_3m<-confusionMatrix(predict(model_AXP_60_3m_target_feature,test_AXP_60_3m_target_feature),test_AXP_60_3m_target_feature$target)
CM_AXP_90_3m<-confusionMatrix(predict(model_AXP_90_3m_target_feature,test_AXP_90_3m_target_feature),test_AXP_90_3m_target_feature$target)
CM_AXP_fun_3m<-confusionMatrix(predict(model_AXP_fun_3m_target_feature,test_AXP_fun_3m_target_feature),test_AXP_fun_3m_target_feature$target)



a<-data.frame(acc1m=as.numeric(c(round(CM_AXP_30_1m$overall[1]*100,2),
                                    round(CM_AXP_60_1m$overall[1]*100,2),
                                   round(CM_AXP_90_1m$overall[1]*100,2),
                                   round(CM_AXP_fun_1m$overall[1]*100,2))),
              sensi1m=as.numeric(c(round(CM_AXP_30_1m$byClass[1]*100,2),
                                    round(CM_AXP_60_1m$byClass[1]*100,2),
                                    round(CM_AXP_90_1m$byClass[1]*100,2),
                                    round(CM_AXP_fun_1m$byClass[1]*100,2))),
              speci1m=as.numeric(c(round(CM_AXP_30_1m$byClass[2]*100,2),
                                    round(CM_AXP_60_1m$byClass[2]*100,2),
                                    round(CM_AXP_90_1m$byClass[2]*100,2),
                                    round(CM_AXP_fun_1m$byClass[2]*100,2))),
              
              acc2m=as.numeric(c(round(CM_AXP_30_2m$overall[1]*100,2),
                                    round(CM_AXP_60_2m$overall[1]*100,2),
                                   round(CM_AXP_90_2m$overall[1]*100,2),
                                   round(CM_AXP_fun_2m$overall[1]*100,2))),
              sensi2m=as.numeric(c(round(CM_AXP_30_2m$byClass[1]*100,2),
                                    round(CM_AXP_60_2m$byClass[1]*100,2),
                                    round(CM_AXP_90_2m$byClass[1]*100,2),
                                    round(CM_AXP_fun_2m$byClass[1]*100,2))),
              speci2m=as.numeric(c(round(CM_AXP_30_2m$byClass[2]*100,2),
                                    round(CM_AXP_60_2m$byClass[2]*100,2),
                                    round(CM_AXP_90_2m$byClass[2]*100,2),
                                    round(CM_AXP_fun_2m$byClass[2]*100,2))),
              
              acc3m=as.numeric(c(round(CM_AXP_30_3m$overall[1]*100,2),
                                    round(CM_AXP_60_3m$overall[1]*100,2),
                                   round(CM_AXP_90_3m$overall[1]*100,2),
                                   round(CM_AXP_fun_3m$overall[1]*100,2))),
              sensi3m=as.numeric(c(round(CM_AXP_30_3m$byClass[1]*100,2),
                                    round(CM_AXP_60_3m$byClass[1]*100,2),
                                    round(CM_AXP_90_3m$byClass[1]*100,2),
                                    round(CM_AXP_fun_3m$byClass[1]*100,2))),
              speci3m=as.numeric(c(round(CM_AXP_30_3m$byClass[2]*100,2),
                                    round(CM_AXP_60_3m$byClass[2]*100,2),
                                    round(CM_AXP_90_3m$byClass[2]*100,2),
                                    round(CM_AXP_fun_3m$byClass[2]*100,2)))
              
              
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

ConfusionAXP<-a
SensiAXP<-ConfusionAXP[,grep(x=names(ConfusionAXP), pattern="sensi")]
SpeciAXP<-ConfusionAXP[,grep(x=names(ConfusionAXP), pattern="speci")]
ConfusionAXP<-ConfusionAXP[,grep(x=names(ConfusionAXP), pattern="acc")]


kable(a, "latex") %>%
  add_header_above(c(" ", "Predicción 1 mes" = 3, "Predicción 2 meses" = 3,"Predicción 3 meses"=3)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))
```
  \captionof{table}{American Express CO.: Metricas de rendimiento sobre muestra test}
  
\setlength\parskip{5ex}

```{r ConfusionMatrixWFC}
CM_WFC_30_1m<-confusionMatrix(predict(model_WFC_30_1m_target_feature,test_WFC_30_1m_target_feature),test_WFC_30_1m_target_feature$target)
CM_WFC_60_1m<-confusionMatrix(predict(model_WFC_60_1m_target_feature,test_WFC_60_1m_target_feature),test_WFC_60_1m_target_feature$target)
CM_WFC_90_1m<-confusionMatrix(predict(model_WFC_90_1m_target_feature,test_WFC_90_1m_target_feature),test_WFC_90_1m_target_feature$target)
CM_WFC_fun_1m<-confusionMatrix(predict(model_WFC_fun_1m_target_feature,test_WFC_fun_1m_target_feature),test_WFC_fun_1m_target_feature$target)


CM_WFC_30_2m<-confusionMatrix(predict(model_WFC_30_2m_target_feature,test_WFC_30_2m_target_feature),test_WFC_30_2m_target_feature$target)
CM_WFC_60_2m<-confusionMatrix(predict(model_WFC_60_2m_target_feature,test_WFC_60_2m_target_feature),test_WFC_60_2m_target_feature$target)
CM_WFC_90_2m<-confusionMatrix(predict(model_WFC_90_2m_target_feature,test_WFC_90_2m_target_feature),test_WFC_90_2m_target_feature$target)
CM_WFC_fun_2m<-confusionMatrix(predict(model_WFC_fun_2m_target_feature,test_WFC_fun_2m_target_feature),test_WFC_fun_2m_target_feature$target)

CM_WFC_30_3m<-confusionMatrix(predict(model_WFC_30_3m_target_feature,test_WFC_30_3m_target_feature),test_WFC_30_3m_target_feature$target)
CM_WFC_60_3m<-confusionMatrix(predict(model_WFC_60_3m_target_feature,test_WFC_60_3m_target_feature),test_WFC_60_3m_target_feature$target)
CM_WFC_90_3m<-confusionMatrix(predict(model_WFC_90_3m_target_feature,test_WFC_90_3m_target_feature),test_WFC_90_3m_target_feature$target)
CM_WFC_fun_3m<-confusionMatrix(predict(model_WFC_fun_3m_target_feature,test_WFC_fun_3m_target_feature),test_WFC_fun_3m_target_feature$target)

a<-data.frame(acc1m=as.numeric(c(round(CM_WFC_30_1m$overall[1]*100,2),
                                    round(CM_WFC_60_1m$overall[1]*100,2),
                                   round(CM_WFC_90_1m$overall[1]*100,2),
                                   round(CM_WFC_fun_1m$overall[1]*100,2))),
              sensi1m=as.numeric(c(round(CM_WFC_30_1m$byClass[1]*100,2),
                                    round(CM_WFC_60_1m$byClass[1]*100,2),
                                    round(CM_WFC_90_1m$byClass[1]*100,2),
                                    round(CM_WFC_fun_1m$byClass[1]*100,2))),
              speci1m=as.numeric(c(round(CM_WFC_30_1m$byClass[2]*100,2),
                                    round(CM_WFC_60_1m$byClass[2]*100,2),
                                    round(CM_WFC_90_1m$byClass[2]*100,2),
                                    round(CM_WFC_fun_1m$byClass[2]*100,2))),
              
              acc2m=as.numeric(c(round(CM_WFC_30_2m$overall[1]*100,2),
                                    round(CM_WFC_60_2m$overall[1]*100,2),
                                   round(CM_WFC_90_2m$overall[1]*100,2),
                                   round(CM_WFC_fun_2m$overall[1]*100,2))),
              sensi2m=as.numeric(c(round(CM_WFC_30_2m$byClass[1]*100,2),
                                    round(CM_WFC_60_2m$byClass[1]*100,2),
                                    round(CM_WFC_90_2m$byClass[1]*100,2),
                                    round(CM_WFC_fun_2m$byClass[1]*100,2))),
              speci2m=as.numeric(c(round(CM_WFC_30_2m$byClass[2]*100,2),
                                    round(CM_WFC_60_2m$byClass[2]*100,2),
                                    round(CM_WFC_90_2m$byClass[2]*100,2),
                                    round(CM_WFC_fun_2m$byClass[2]*100,2))),
              
              acc3m=as.numeric(c(round(CM_WFC_30_3m$overall[1]*100,2),
                                    round(CM_WFC_60_3m$overall[1]*100,2),
                                   round(CM_WFC_90_3m$overall[1]*100,2),
                                   round(CM_WFC_fun_3m$overall[1]*100,2))),
              sensi3m=as.numeric(c(round(CM_WFC_30_3m$byClass[1]*100,2),
                                    round(CM_WFC_60_3m$byClass[1]*100,2),
                                    round(CM_WFC_90_3m$byClass[1]*100,2),
                                    round(CM_WFC_fun_3m$byClass[1]*100,2))),
              speci3m=as.numeric(c(round(CM_WFC_30_3m$byClass[2]*100,2),
                                    round(CM_WFC_60_3m$byClass[2]*100,2),
                                    round(CM_WFC_90_3m$byClass[2]*100,2),
                                    round(CM_WFC_fun_3m$byClass[2]*100,2)))
              
              
              
              ) 

rownames(a)<-c("EMA30","EMA60","EMA90","Alisado exponencial")

ConfusionWFC<-a
SensiWFC<-ConfusionWFC[,grep(x=names(ConfusionWFC), pattern="sensi")]
SpeciWFC<-ConfusionWFC[,grep(x=names(ConfusionWFC), pattern="speci")]
ConfusionWFC<-ConfusionWFC[,grep(x=names(ConfusionWFC), pattern="acc")]


kable(a, "latex") %>%
  add_header_above(c(" ", "Predicción 1 mes" = 3, "Predicción 2 meses" = 3,"Predicción 3 meses"=3)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))
```
  \captionof{table}{Wells and Fargo CO.: Metricas de rendimiento sobre muestra test}
  
\setlength\parskip{5ex}
\justifying 
```{r}
#poner el heatmap en el markdown a modo de report useful para hacer investment
acc.heatmap<-ConfusionKO %>% rbind(ConfusionAAPL)%>% rbind(ConfusionAXP)%>% rbind(ConfusionWFC)

rownames(acc.heatmap)<-apply(expand.grid(c("EMA30","EMA60","EMA90","smooth f"), c("KO", "AAPL", "AXP", "WFC")), 1, paste, collapse=".")

acc.heatmap$comb<-rownames(acc.heatmap);rownames(acc.heatmap)<-NULL;acc.heatmap$comb<-rep(c("EMA30","EMA60","EMA90","smooth f"),4)

stock.heatmap <- acc.heatmap %>% 
  select(comb,acc1m,acc2m,acc3m)%>% 
  gather("forecast.window","test.acc", 2:4) %>%          
  cbind(company=rep(c("KO","AAPL","AXP","WFC"),each=4),
        test.acc.label=as.character(.$test.acc)) %>% 
  
  ggplot(mapping = aes(x = comb, y = forecast.window,fill = test.acc)) +
  geom_tile() +
  geom_text(aes(label=test.acc.label),size=2)+
  xlab(label = "Smooth type")+
  facet_grid(~ company, switch = "x", scales = "free_x", space = "free_x")+
scale_fill_gradient2('test.acc', low = "blue", mid = "white", high = "red", midpoint = 50)+
theme_bw()+
  theme(
    axis.text.x = element_text(angle=90, hjust = 0.5 )
  )

stock.heatmap
#https://jcoliver.github.io/learn-r/006-heatmaps.html
```
  \captionof{figure}{Heatmap de la accuracy obtenida con los modelos Random Forest sobre muestra test}

\setlength\parskip{5ex}
\justifying 

La representación de la accuracy obtenida sobre la muestra de prueba con los distintos modelos Random Forest permite visualizar de una manera más global. En general los mejores resultados se obtienen prediciendo si el precio de cierre será superior o inferior al cabo de un mes. Este resultado se puede observar de manera general para las 4 empresas estudiadas. Otro resultado que se puede apreciar fácilmente para las 4 empresas es el hecho de que el mejor rendimiento se obtiene a corto plazo (prediciendo a 1 mes) utilizando los datos alisados con una EMA 90 días. Este resultado tiene una fácil interpretación: este tipo de alisado es el más agresivo en cuanto a la fuerza del mismo. Esto significa que se remueven de una manera más clara los movimientos día a día y se conserva de una manera más fuerte la tendencia general.

\setlength\parskip{5ex}
\justifying 
Sin embargo cuando se analiza el resultado para cada una de las empresas, se puede apreciar que el resultado es totalmente distinto. Para el caso de AAPL se puede observar que el rendimiento del modelo predictivo se reduce a medida que se aleja en el tiempo la predicción. Cuando se intenta predecir si el precio será superior o inferior al cabo de tres meses, el rendimiento que se obtiene es inferior al 50% de accuracy


```{r}
#poner el heatmap en el markdown a modo de report useful para hacer investment
sensi.heatmap<-SensiKO %>% rbind(SensiAAPL)%>% rbind(SensiAAPL)%>% rbind(SensiWFC)

rownames(sensi.heatmap)<-apply(expand.grid(c("EMA30","EMA60","EMA90","smooth f"), c("KO", "AAPL", "AXP", "WFC")), 1, paste, collapse=".")

sensi.heatmap$comb<-rownames(sensi.heatmap);rownames(sensi.heatmap)<-NULL;sensi.heatmap$comb<-rep(c("EMA30","EMA60","EMA90","smooth f"),4)

stock.heatmap.sensi <- sensi.heatmap %>% 
  select(comb,sensi1m,sensi2m,sensi3m)%>% 
  gather("forecast.window","test.sensi", 2:4) %>%          
  cbind(company=rep(c("KO","AAPL","AXP","WFC"),each=4),
        test.sensi.label=as.character(.$test.sensi)) %>% 
  
  ggplot(mapping = aes(x = comb, y = forecast.window,fill = test.sensi)) +
  geom_tile() +
  geom_text(aes(label=test.sensi.label),size=2)+
  xlab(label = "Smooth type")+
  facet_grid(~ company, switch = "x", scales = "free_x", space = "free_x")+
scale_fill_gradient2('test.sensi', low = "blue", mid = "white", high = "red", midpoint = 50)+
theme_bw()+
  theme(
    axis.text.x = element_text(angle=90, hjust = 0.5 )
  )

stock.heatmap.sensi
#https://jcoliver.github.io/learn-r/006-heatmaps.html
```
  \captionof{figure}{Heatmap de la sensitividad obtenida con los modelos Random Forest sobre muestra test}

\setlength\parskip{5ex}
\justifying 


\setlength\parskip{5ex}
\justifying 

```{r}
#poner el heatmap en el markdown a modo de report useful para hacer investment
speci.heatmap<-SpeciKO %>% rbind(SpeciAAPL)%>% rbind(SpeciAAPL)%>% rbind(SpeciWFC)

rownames(speci.heatmap)<-apply(expand.grid(c("EMA30","EMA60","EMA90","smooth f"), c("KO", "AAPL", "AXP", "WFC")), 1, paste, collapse=".")

speci.heatmap$comb<-rownames(speci.heatmap);rownames(speci.heatmap)<-NULL;speci.heatmap$comb<-rep(c("EMA30","EMA60","EMA90","smooth f"),4)

stock.heatmap.speci <- speci.heatmap %>% 
  select(comb,speci1m,speci2m,speci3m)%>% 
  gather("forecast.window","test.speci", 2:4) %>%          
  cbind(company=rep(c("KO","AAPL","AXP","WFC"),each=4),
        test.speci.label=as.character(.$test.speci)) %>% 
  
  ggplot(mapping = aes(x = comb, y = forecast.window,fill = test.speci)) +
  geom_tile() +
  geom_text(aes(label=test.speci.label),size=2)+
  xlab(label = "Smooth type")+
  facet_grid(~ company, switch = "x", scales = "free_x", space = "free_x")+
scale_fill_gradient2('test.speci', low = "blue", mid = "white", high = "red", midpoint = 50)+
theme_bw()+
  theme(
    axis.text.x = element_text(angle=90, hjust = 0.5 )
  )

stock.heatmap.speci
#https://jcoliver.github.io/learn-r/006-heatmaps.html
```
  \captionof{figure}{Heatmap de la especificidad obtenida con los modelos Random Forest sobre muestra test}

\setlength\parskip{5ex}
\justifying 


PONER LAS TABLAS CON LA MEDIA DE ACCURACY OBTENIDA ENTRE TODOS LOS ALISADOS. CREAR REGLA: SI COMO MINIMO 3 ALISADOS DICEN QUE SUBIRA, ES MAS ROBUSTO...

*Importancia de las variables*
A la hora de construir los árboles que conforman el bosque aleatorio ciertas variables son más importantes que otras. Éstas son las variables que consiguen partir mejor la base de datos, es decir, son las que consiguen que los nodos hijos sean los más puros posibles. En otras palabras: las variables más importantes a la hora de crear las particiones son aquellas que consiguen una mayor reducción de la impureza. En este sentido en las tablas siguientes se muestran las 4 variables más importantes para cada modelo construido con un alisado distinto. Dichas variables estan ordenadas de mayor a menor decrecimiento medio en la medida de impureza de Gini [@RF].

```{r}
a<-data.frame(Var1=c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    ),
              Var1.n=names(c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    )),
              Var2=c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    ),
              Var2.n=names(c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    )),
              Var3=c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    ),
              Var3.n=names(c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    )),
              Var4=c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ),
              Var4.n=names(c(sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_KO_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_KO_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ))
              )
rownames(a)<-c("EMA30 + target 1mes","EMA30 + target 2mes","EMA30 + target 3mes",
               "EMA60 + target 1mes","EMA60 + target 2mes","EMA60 + target 3mes",
               "EMA90 + target 1mes","EMA90 + target 2mes","EMA90 + target 3mes",
               "exp smooth + target 1mes","exp smooth + target 2mes","exp smooth + target 3mes")

imp_KO<-a

kable(a, "latex") %>%
add_header_above(c(" ", "Variables ordenadas de mayor a menor importancia de izq. a dcha." = 8)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))

# sort(model_KO_30_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_KO_30_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_KO_30_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_KO_60_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_KO_60_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_KO_60_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_KO_90_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_KO_90_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_KO_90_3m_target_feature$importance[,1],decreasing = T)[1:5]

```
  \captionof{table}{Coca Cola CO.: Importancia de las variables en los modelos Random Forest}
  
\setlength\parskip{5ex}

```{r}
a<-data.frame(Var1=c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    ),
              Var1.n=names(c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    )),
              Var2=c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    ),
              Var2.n=names(c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    )),
              Var3=c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    ),
              Var3.n=names(c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    )),
              Var4=c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ),
              Var4.n=names(c(sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_AAPL_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AAPL_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ))
              )
rownames(a)<-c("EMA30 + target 1mes","EMA30 + target 2mes","EMA30 + target 3mes",
               "EMA60 + target 1mes","EMA60 + target 2mes","EMA60 + target 3mes",
               "EMA90 + target 1mes","EMA90 + target 2mes","EMA90 + target 3mes",
               "exp smooth + target 1mes","exp smooth + target 2mes","exp smooth + target 3mes")

imp_AAPL<-a

kable(a, "latex") %>%
add_header_above(c(" ", "Variables ordenadas de mayor a menor importancia de izq. a dcha." = 8)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))

# sort(model_AAPL_30_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AAPL_30_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AAPL_30_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_AAPL_60_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AAPL_60_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AAPL_60_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_AAPL_90_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AAPL_90_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AAPL_90_3m_target_feature$importance[,1],decreasing = T)[1:5]

```
  \captionof{table}{Apple Inc.: Importancia de las variables en los modelos Random Forest}
  
\setlength\parskip{5ex}

```{r}
a<-data.frame(Var1=c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    ),
              Var1.n=names(c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    )),
              Var2=c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    ),
              Var2.n=names(c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    )),
              Var3=c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    ),
              Var3.n=names(c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    )),
              Var4=c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ),
              Var4.n=names(c(sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_AXP_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_AXP_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ))
              )
rownames(a)<-c("EMA30 + target 1mes","EMA30 + target 2mes","EMA30 + target 3mes",
               "EMA60 + target 1mes","EMA60 + target 2mes","EMA60 + target 3mes",
               "EMA90 + target 1mes","EMA90 + target 2mes","EMA90 + target 3mes",
               "exp smooth + target 1mes","exp smooth + target 2mes","exp smooth + target 3mes")

imp_AXP<-a

kable(a, "latex") %>%
add_header_above(c(" ", "Variables ordenadas de mayor a menor importancia de izq. a dcha." = 8)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))
# sort(model_AXP_30_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AXP_30_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AXP_30_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_AXP_60_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AXP_60_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AXP_60_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_AXP_90_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AXP_90_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_AXP_90_3m_target_feature$importance[,1],decreasing = T)[1:5]

```
  \captionof{table}{American Express CO.: Importancia de las variables en los modelos Random Forest}
  
\setlength\parskip{5ex}

```{r}
a<-data.frame(Var1=c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    ),
              Var1.n=names(c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[1],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[1],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[1],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[1],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[1]
                    )),
              Var2=c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    ),
              Var2.n=names(c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[2],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[2],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[2],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[2],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[2]
                    )),
              Var3=c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    ),
              Var3.n=names(c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[3],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[3],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[3],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[3],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[3]
                    )),
              Var4=c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ),
              Var4.n=names(c(sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[4],
                     sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[4],
                      
                      sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[4],
                     
                     sort(model_WFC_fun_1m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_fun_2m_target_feature$importance[,1],decreasing = T)[4],
                      sort(model_WFC_fun_3m_target_feature$importance[,1],decreasing = T)[4]
                    ))
              )
rownames(a)<-c("EMA30 + target 1mes","EMA30 + target 2mes","EMA30 + target 3mes",
               "EMA60 + target 1mes","EMA60 + target 2mes","EMA60 + target 3mes",
               "EMA90 + target 1mes","EMA90 + target 2mes","EMA90 + target 3mes",
               "exp smooth + target 1mes","exp smooth + target 2mes","exp smooth + target 3mes")

imp_WFC<-a

kable(a, "latex") %>%
add_header_above(c(" ", "Variables ordenadas de mayor a menor importancia de izq. a dcha." = 8)) %>%
  kable_styling(font_size = 10,latex_options = c("basic"))


# sort(model_WFC_30_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_WFC_30_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_WFC_30_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_WFC_60_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_WFC_60_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_WFC_60_3m_target_feature$importance[,1],decreasing = T)[1:5]
# 
# sort(model_WFC_90_1m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_WFC_90_2m_target_feature$importance[,1],decreasing = T)[1:5]
# sort(model_WFC_90_3m_target_feature$importance[,1],decreasing = T)[1:5]

```
  \captionof{table}{Wells and Fargo CO.: Importancia de las variables en los modelos Random Forest}
  
\setlength\parskip{5ex}

```{r}
#Cuál ha sido la variable más importante en el split con la freq absoluta más alta de entre todos los modelos de todas las empresas?
table(c(as.character(imp_KO[,2]),as.character(imp_AAPL[,2]),as.character(imp_AXP[,2]),as.character(imp_WFC[,2])))

#El indicador técnico aparece un 39.58% de las veces como variable más importante para un modelo, seguida de atr 20.83 y sma10 20.83 empatadas 
round(table(c(as.character(imp_KO[,2]),as.character(imp_AAPL[,2]),as.character(imp_AXP[,2]),as.character(imp_WFC[,2])))/sum(table(c(as.character(imp_KO[,2]),as.character(imp_AAPL[,2]),as.character(imp_AXP[,2]),as.character(imp_WFC[,2]))))*100,2)

#Cuál ha sido la variable más importante en el split con la freq absoluta más alta de entre todos los modelos para cada empresa??
sort(round(table(c(as.character(imp_KO[,2])))/sum(table(c(as.character(imp_KO[,2]))))*100,2),decreasing = T)
sort(round(table(c(as.character(imp_AAPL[,2])))/sum(table(c(as.character(imp_AAPL[,2]))))*100,2),decreasing = T)
sort(round(table(c(as.character(imp_AXP[,2])))/sum(table(c(as.character(imp_AXP[,2]))))*100,2),decreasing = T)
sort(round(table(c(as.character(imp_WFC[,2])))/sum(table(c(as.character(imp_WFC[,2]))))*100,2),decreasing = T)

#Para cada tipo de modelo cuales son las variables que más aparecen en el top 4 de más importantes
# table(c(as.character(t(imp_KO[1,c(2,4,6,8)])),as.character(t(imp_AAPL[1,c(2,4,6,8)])),as.character(t(imp_AXP[1,c(2,4,6,8)])),as.character(t(imp_WFC[1,c(2,4,6,8)]))))


```



*Experimentos con los datos sin alisar*

*poner aqui los precios reales para poder comparar... si se predice con la ema90 que subira, es verdad que en ese momento el precio estava mas alto que cuando se hizo la predicción?
